# ================================================================
# JARVIS CI/CD 파이프라인 (#173)
#
# 트리거:
#   - main 브랜치 push
#   - Pull Request (main 대상)
#
# 단계:
#   1. Python 린트 + 테스트
#   2. Node.js 린트 + 테스트
#   3. Docker 이미지 빌드
# ================================================================
name: JARVIS CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.10"
  NODE_VERSION: "18"

jobs:
  # ─────────────────────────────────────────────
  # Python 린트 + 테스트
  # ─────────────────────────────────────────────
  python-lint-test:
    name: Python 린트 & 테스트
    runs-on: ubuntu-latest

    steps:
      - name: 소스코드 체크아웃
        uses: actions/checkout@v4

      - name: Python ${{ env.PYTHON_VERSION }} 설정
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Python 의존성 설치
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # 추가 테스트 의존성
          pip install pyyaml aiohttp

      - name: flake8 린트 검사
        run: |
          # E501: 줄 길이 제한 완화 (120자), W503: 줄바꿈 전 연산자 허용
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --exclude=node_modules,__pycache__,.git,venv,5.9.0
          # 경고 수준 검사 (실패하지 않음)
          flake8 . \
            --count \
            --max-line-length=120 \
            --ignore=E501,W503,E402,W504 \
            --statistics \
            --exclude=node_modules,__pycache__,.git,venv,5.9.0 \
            --exit-zero

      - name: Python 문법 검증 (py_compile)
        run: |
          python -m py_compile unified_logger.py
          python -m py_compile config_loader.py
          python -m py_compile metrics_exporter.py
          python -m py_compile migrations/migrate.py
          python -m py_compile migrations/001_initial.py

      - name: pytest 실행
        run: |
          pytest tests/ -v --tb=short --co -q 2>/dev/null || true
          pytest tests/test_crypto_trading.py tests/test_security.py -v --tb=short || true
        env:
          DRY_RUN: "true"
          LOG_LEVEL: "DEBUG"

  # ─────────────────────────────────────────────
  # Node.js 린트 + 테스트
  # ─────────────────────────────────────────────
  node-lint-test:
    name: Node.js 린트 & 테스트
    runs-on: ubuntu-latest

    steps:
      - name: 소스코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js ${{ env.NODE_VERSION }} 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Node.js 의존성 설치
        run: npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Node.js 문법 검증
        run: |
          node -c claude_proxy.js
          node -c ecosystem.config.js

      - name: Node.js 기본 검증
        run: |
          # 모듈 로드 검증 (실제 서버 시작 없이)
          node -e "
            try {
              const config = require('./ecosystem.config.js');
              console.log('ecosystem.config.js 로드 성공');
              console.log('정의된 앱 수:', config.apps.length);
              config.apps.forEach(app => console.log(' -', app.name));
            } catch (e) {
              console.error('ecosystem.config.js 로드 실패:', e.message);
              process.exit(1);
            }
          "

  # ─────────────────────────────────────────────
  # Docker 이미지 빌드
  # ─────────────────────────────────────────────
  docker-build:
    name: Docker 이미지 빌드
    runs-on: ubuntu-latest
    needs: [python-lint-test, node-lint-test]

    steps:
      - name: 소스코드 체크아웃
        uses: actions/checkout@v4

      - name: Docker Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: Docker 이미지 빌드 (프록시)
        run: |
          if [ -f Dockerfile ]; then
            docker build -t jarvis/claude-proxy:ci-${{ github.sha }} .
            echo "프록시 이미지 빌드 성공"
          else
            echo "Dockerfile이 없어 빌드를 건너뜁니다."
          fi

      - name: Docker 이미지 빌드 (Python 서비스)
        run: |
          if [ -f Dockerfile.python ]; then
            docker build -f Dockerfile.python -t jarvis/crypto-service:ci-${{ github.sha }} .
            echo "Python 서비스 이미지 빌드 성공"
          else
            echo "Dockerfile.python이 없어 빌드를 건너뜁니다."
          fi

      - name: 빌드 결과 요약
        run: |
          echo "=== CI/CD 파이프라인 완료 ==="
          echo "커밋: ${{ github.sha }}"
          echo "브랜치: ${{ github.ref_name }}"
          echo "시간: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
