#!/bin/bash
# ═══════════════════════════════════════════════════
#  JARVIS Git Pre-Commit Hook (#166)
#  - 커밋 전 API 키 유출 검사
#  - .py 파일 구문 체크 (python -m py_compile)
#  - .js 파일 구문 체크 (node --check)
#
#  설치 방법:
#    git config core.hooksPath .githooks
#  또는:
#    cp .githooks/pre-commit .git/hooks/pre-commit
#    chmod +x .git/hooks/pre-commit
# ═══════════════════════════════════════════════════

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo "================================================"
echo "  JARVIS Pre-Commit Hook 검사 시작"
echo "================================================"
echo ""

ERRORS=0
WARNINGS=0

# ── 1. API 키 유출 검사 ──

echo "[1/3] API 키 유출 검사..."

# 커밋 대상 파일 목록 (staged files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo -e "  ${GREEN}[OK]${NC} 커밋 대상 파일 없음"
else
    # API 키 패턴 정의 (정규식)
    # 실제 키 값을 감지하는 패턴 (변수명 할당이 아닌 실제 값)
    KEY_PATTERNS=(
        'sk-ant-[a-zA-Z0-9_\-]{20,}'           # Anthropic API Key
        'sk-ant-sid[a-zA-Z0-9_\-]{20,}'         # Anthropic Session Key
        'AIzaSy[a-zA-Z0-9_\-]{30,}'             # Google API Key
        'xox[bpras]-[a-zA-Z0-9\-]{10,}'         # Slack Token
        'ghp_[a-zA-Z0-9]{36}'                   # GitHub Personal Access Token
        'gho_[a-zA-Z0-9]{36}'                   # GitHub OAuth Token
        'AKIA[A-Z0-9]{16}'                      # AWS Access Key ID
        'sk-[a-zA-Z0-9]{20,}'                   # OpenAI / Generic SK
    )

    # 검사 제외 패턴 (파일 경로)
    EXCLUDE_PATTERNS=(
        '\.env\.example$'
        '\.env\.sample$'
        'node_modules/'
        'package-lock\.json$'
        '\.gitignore$'
        '\.githooks/'
        '\.md$'
    )

    LEAKED_FILES=()

    for file in $STAGED_FILES; do
        # 제외 파일 체크
        skip=false
        for exclude in "${EXCLUDE_PATTERNS[@]}"; do
            if echo "$file" | grep -qE "$exclude"; then
                skip=true
                break
            fi
        done
        if $skip; then
            continue
        fi

        # .env 파일 자체가 커밋되는지 확인
        if echo "$file" | grep -qE '\.env(\.[a-zA-Z]+)?$'; then
            if echo "$file" | grep -qvE '\.example$|\.sample$'; then
                echo -e "  ${RED}[차단]${NC} 환경변수 파일 커밋 시도: $file"
                LEAKED_FILES+=("$file (환경변수 파일)")
                continue
            fi
        fi

        # staged 내용에서 키 패턴 검색
        DIFF_CONTENT=$(git diff --cached -- "$file" 2>/dev/null || true)
        if [ -z "$DIFF_CONTENT" ]; then
            continue
        fi

        for pattern in "${KEY_PATTERNS[@]}"; do
            # 추가된 줄(+)에서만 검색 (삭제된 줄 무시)
            MATCHES=$(echo "$DIFF_CONTENT" | grep '^+' | grep -oE "$pattern" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
                echo -e "  ${RED}[차단]${NC} API 키 유출 의심: $file"
                echo -e "         패턴: $pattern"
                # 키 값은 마스킹하여 출력
                while IFS= read -r match; do
                    masked="${match:0:8}...${match: -4}"
                    echo -e "         값: $masked"
                done <<< "$MATCHES"
                LEAKED_FILES+=("$file")
                break  # 파일당 1개만 보고
            fi
        done
    done

    if [ ${#LEAKED_FILES[@]} -gt 0 ]; then
        echo ""
        echo -e "  ${RED}[실패]${NC} API 키 유출 감지: ${#LEAKED_FILES[@]}개 파일"
        echo -e "  ${YELLOW}해결 방법:${NC}"
        echo "    1. API 키를 .env.jarvis 파일로 이동 (gitignore 대상)"
        echo "    2. 환경변수 참조로 변경: os.environ.get('KEY_NAME')"
        echo "    3. 의도적인 경우: git commit --no-verify"
        ERRORS=$((ERRORS + ${#LEAKED_FILES[@]}))
    else
        echo -e "  ${GREEN}[OK]${NC} API 키 유출 없음"
    fi
fi

# ── 2. Python 파일 구문 체크 ──

echo ""
echo "[2/3] Python 파일 구문 체크..."

PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)
PY_ERRORS=0

if [ -z "$PY_FILES" ]; then
    echo -e "  ${GREEN}[OK]${NC} 커밋 대상 .py 파일 없음"
else
    # Python 실행 파일 확인
    PYTHON_CMD=""
    if command -v python3 &>/dev/null; then
        PYTHON_CMD="python3"
    elif command -v python &>/dev/null; then
        PYTHON_CMD="python"
    fi

    if [ -z "$PYTHON_CMD" ]; then
        echo -e "  ${YELLOW}[건너뜀]${NC} Python이 설치되지 않음"
        WARNINGS=$((WARNINGS + 1))
    else
        for file in $PY_FILES; do
            # 파일이 존재하는지 확인 (삭제된 파일 제외)
            if [ ! -f "$file" ]; then
                continue
            fi

            if $PYTHON_CMD -m py_compile "$file" 2>/dev/null; then
                echo -e "  ${GREEN}[OK]${NC} $file"
            else
                echo -e "  ${RED}[실패]${NC} $file - 구문 오류"
                # 상세 오류 메시지 출력
                $PYTHON_CMD -m py_compile "$file" 2>&1 | head -5
                PY_ERRORS=$((PY_ERRORS + 1))
            fi

            # py_compile이 생성하는 __pycache__ 정리
            pycache_dir="$(dirname "$file")/__pycache__"
            if [ -d "$pycache_dir" ]; then
                find "$pycache_dir" -name "*.pyc" -newer "$file" -delete 2>/dev/null || true
            fi
        done

        if [ $PY_ERRORS -gt 0 ]; then
            echo -e "  ${RED}[실패]${NC} Python 구문 오류: ${PY_ERRORS}개 파일"
            ERRORS=$((ERRORS + PY_ERRORS))
        else
            echo -e "  ${GREEN}[OK]${NC} 모든 .py 파일 구문 정상"
        fi
    fi
fi

# ── 3. JavaScript 파일 구문 체크 ──

echo ""
echo "[3/3] JavaScript 파일 구문 체크..."

JS_FILES=$(echo "$STAGED_FILES" | grep '\.js$' | grep -v 'node_modules/' || true)
JS_ERRORS=0

if [ -z "$JS_FILES" ]; then
    echo -e "  ${GREEN}[OK]${NC} 커밋 대상 .js 파일 없음"
else
    if ! command -v node &>/dev/null; then
        echo -e "  ${YELLOW}[건너뜀]${NC} Node.js가 설치되지 않음"
        WARNINGS=$((WARNINGS + 1))
    else
        for file in $JS_FILES; do
            # 파일이 존재하는지 확인
            if [ ! -f "$file" ]; then
                continue
            fi

            if node --check "$file" 2>/dev/null; then
                echo -e "  ${GREEN}[OK]${NC} $file"
            else
                echo -e "  ${RED}[실패]${NC} $file - 구문 오류"
                node --check "$file" 2>&1 | head -5
                JS_ERRORS=$((JS_ERRORS + 1))
            fi
        done

        if [ $JS_ERRORS -gt 0 ]; then
            echo -e "  ${RED}[실패]${NC} JavaScript 구문 오류: ${JS_ERRORS}개 파일"
            ERRORS=$((ERRORS + JS_ERRORS))
        else
            echo -e "  ${GREEN}[OK]${NC} 모든 .js 파일 구문 정상"
        fi
    fi
fi

# ── 결과 요약 ──

echo ""
echo "================================================"
if [ $ERRORS -gt 0 ]; then
    echo -e "  ${RED}검사 실패: ${ERRORS}개 오류, ${WARNINGS}개 경고${NC}"
    echo ""
    echo "  커밋이 차단되었습니다."
    echo "  오류를 수정한 후 다시 시도하세요."
    echo "  (검사 우회: git commit --no-verify)"
    echo "================================================"
    echo ""
    exit 1
else
    if [ $WARNINGS -gt 0 ]; then
        echo -e "  ${YELLOW}검사 통과 (경고 ${WARNINGS}개)${NC}"
    else
        echo -e "  ${GREEN}모든 검사 통과${NC}"
    fi
    echo "================================================"
    echo ""
    exit 0
fi
